name: "Test matrix of OSes and Nix"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '*'

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          # - ubuntu-24.04
          # - ubuntu-22.04
          # - ubuntu-20.04
          - macos-latest
          # - macos-15
          # - macos-14
          - macos-13

      - name: Metadata about the runs-on machine before everything
        run: |
          id
          stat /dev/kvm || true            
          uname -a
          cat /etc/os-release || true
          cat /etc/lsb-release || true
          cat /proc/cpuinfo || true
          cat /proc/meminfo || true
          df -h || true
          free -h || true
          nproc || true
          lscpu || true
          sysctl -a || true
          sysctl -a | grep -i mem || true
          sysctl -a | grep -i cpu || true
          sysctl -a | grep -i vm || true
          sysctl -a | grep -i sched || true
          sysctl -a | grep -i numa || true

      - uses: DeterminateSystems/nix-installer-action@v16
        with:
          source-tag: v0.38.1
          diagnostic-endpoint: ""

      - name: Build pkgsStatic.hello for testing nix
        run: |
          nix flake --version
          # nix registry list
          nix registry pin nixpkgs github:NixOS/nixpkgs/1546c45c538633ae40b93e2d14e0bb6fd8f13347
          nix run nixpkgs#nix-info -- --markdown
          nix flake metadata nixpkgs
          nix build --no-link --print-out-paths nixpkgs#pkgsStatic.hello
          nix build --no-link --print-out-paths nixpkgs#pkgsStatic.sqlite

      - name: Run Nix Build
        run: |
          nix flake --version
          nix flake metadata nixpkgs
          nix build --print-build-logs nixpkgs#pkgsStatic.hello
